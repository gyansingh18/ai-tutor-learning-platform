<div class="container-fluid">
  <!-- Header -->
  <div class="text-center mb-4 fade-in">
    <h2 class="text-primary mb-2">
      <i class="fas fa-lightbulb me-2"></i>
      Visual Explanation: <%= @topic %>
    </h2>
    <p class="text-muted">
      <i class="fas fa-book me-1"></i>
      <%= @chapter.display_name %>
    </p>
  </div>

  <% if @explanation[:success] %>
    <!-- Success State -->
    <div class="row">
      <!-- Image Section -->
      <div class="col-lg-6 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-image me-2"></i>
              AI-Generated Illustration
            </h5>
          </div>
          <div class="card-body text-center">
            <% if @explanation[:image_url] %>
              <img src="<%= @explanation[:image_url] %>"
                   alt="AI-generated illustration for <%= @topic %>"
                   class="img-fluid rounded shadow-lg"
                   style="max-height: 400px; object-fit: contain;">
              <div class="mt-3">
                <small class="text-muted">
                  <i class="fas fa-robot me-1"></i>
                  Generated by DALL-E AI
                </small>
              </div>
            <% else %>
              <div class="text-center py-5">
                <i class="fas fa-image fa-4x text-muted mb-3"></i>
                <p class="text-muted">Image generation failed</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Explanation Section -->
      <div class="col-lg-6 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-comment-dots me-2"></i>
              AI Explanation
            </h5>
          </div>
          <div class="card-body">
            <div class="explanation-content">
              <%= simple_format(@explanation[:explanation]) %>
            </div>

            <div class="mt-4">
              <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                Generated just now
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive Chat Section -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-comments me-2"></i>
              Continue the Conversation
            </h5>
          </div>
          <div class="card-body">
            <div id="chat-messages" class="mb-3" style="max-height: 300px; overflow-y: auto;">
              <!-- Chat messages will appear here -->
            </div>

            <div class="input-group">
              <input type="text"
                     id="user-message"
                     class="form-control"
                     placeholder="Ask a follow-up question..."
                     data-chapter-id="<%= @chapter.id %>"
                     data-topic="<%= @topic %>"
                     data-conversation-id="<%= @explanation[:conversation_id] %>">
              <button class="btn btn-primary" type="button" id="send-message">
                <i class="fas fa-paper-plane me-1"></i>
                Send
              </button>
            </div>

            <div class="mt-2">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Images will update intelligently based on your questions
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

  <% else %>
    <!-- Error State -->
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body text-center">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5 class="text-danger">Generation Failed</h5>
            <p class="text-muted"><%= @explanation[:error] %></p>
            <%= link_to "Try Again", test_index_path, class: "btn btn-primary" %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Back Button -->
  <div class="text-center mt-4">
    <%= link_to test_index_path, class: "btn btn-outline-secondary" do %>
      <i class="fas fa-arrow-left me-2"></i>
      Back to Test Page
    <% end %>
  </div>
</div>

<!-- JavaScript for Chat Functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const messageInput = document.getElementById('user-message');
  const sendButton = document.getElementById('send-message');
  const chatMessages = document.getElementById('chat-messages');

  let conversationHistory = [];

  function addMessage(message, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 ${isUser ? 'text-end' : ''}`;

    const messageContent = document.createElement('div');
    messageContent.className = `d-inline-block p-3 rounded ${isUser ? 'bg-primary text-white' : 'bg-light'}`;
    messageContent.style.maxWidth = '80%';
    messageContent.textContent = message;

    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message to chat
    addMessage(message, true);

    // Clear input
    messageInput.value = '';

    // Disable input while processing
    messageInput.disabled = true;
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';

    // Prepare data
    const data = {
      chapter_id: messageInput.dataset.chapterId,
      topic: messageInput.dataset.topic,
      conversation_history: conversationHistory,
      user_message: message
    };

    // Send request
    fetch('/test/continue_explanation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Add AI response to chat
        addMessage(data.response);

        // Update conversation history
        conversationHistory.push({
          user_message: message,
          ai_response: data.response
        });

        // Update image if new one was generated
        if (data.should_generate_image && data.image_url) {
          const imageContainer = document.querySelector('.card img');
          if (imageContainer) {
            imageContainer.src = data.image_url;
            imageContainer.style.opacity = '0.7';
            setTimeout(() => {
              imageContainer.style.opacity = '1';
            }, 300);
          }
        }
      } else {
        addMessage('Sorry, I encountered an error. Please try again.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      addMessage('Sorry, I encountered an error. Please try again.');
    })
    .finally(() => {
      // Re-enable input
      messageInput.disabled = false;
      sendButton.disabled = false;
      sendButton.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
      messageInput.focus();
    });
  }

  // Event listeners
  sendButton.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
});
</script>
