<div class="container mt-4">
  <div class="row">
    <div class="col-md-8">
      <h1 class="display-4 text-primary">AI Tutor</h1>
      <p class="lead">Your personal AI learning companion</p>

      <!-- Learning Statistics for logged-in users -->
      <% if user_signed_in? && @learning_stats %>
        <div class="row mb-4">
          <div class="col-12">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title text-primary">
                  <i class="fas fa-chart-bar me-2"></i>
                  Your Learning Progress
                </h6>
                <div class="row text-center">
                  <div class="col-md-3">
                    <h4 class="text-primary"><%= @learning_stats[:total_chapters_started] %></h4>
                    <small class="text-muted">Chapters Started</small>
                  </div>
                  <div class="col-md-3">
                    <h4 class="text-success"><%= @learning_stats[:completed_chapters] %></h4>
                    <small class="text-muted">Chapters Completed</small>
                  </div>
                  <div class="col-md-3">
                    <h4 class="text-info"><%= @learning_stats[:total_tasks_completed] %></h4>
                    <small class="text-muted">Tasks Completed</small>
                  </div>
                  <div class="col-md-3">
                    <h4 class="text-warning"><%= @learning_stats[:accuracy_rate] %>%</h4>
                    <small class="text-muted">Accuracy Rate</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Resume Learning Section -->
      <% if user_signed_in? && @resume_chapter %>
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-primary">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                  <i class="fas fa-play-circle me-2"></i>
                  Resume Learning
                </h6>
              </div>
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-8">
                    <h6 class="text-primary mb-1">Continue where you left off:</h6>
                    <p class="mb-2">
                      <strong><%= @resume_chapter.display_name %></strong>
                      <br>
                      <small class="text-muted">
                        <%= @resume_chapter.subject.name %> â€¢ <%= @resume_chapter.subject.grade.display_name %>
                      </small>
                    </p>
                    <% 
                      total_tasks = @resume_chapter.tasks.count
                      completed_tasks = @resume_chapter.tasks.joins(:student_answers)
                                                   .where(student_answers: { user: current_user })
                                                   .distinct.count
                      progress_percentage = total_tasks > 0 ? (completed_tasks.to_f / total_tasks * 100).round : 0
                    %>
                    <div class="progress mb-2" style="height: 6px;">
                      <div class="progress-bar bg-success" role="progressbar" 
                           style="width: <%= progress_percentage %>%" 
                           aria-valuenow="<%= progress_percentage %>" 
                           aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted">
                      <%= completed_tasks %> of <%= total_tasks %> tasks completed (<%= progress_percentage %>%)
                    </small>
                  </div>
                  <div class="col-md-4 text-end">
                    <%= link_to learning_path(@resume_chapter), class: "btn btn-primary btn-lg" do %>
                      <i class="fas fa-play me-2"></i>
                      Resume Learning
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Start Learning</h5>
          <p class="card-text">Select your grade, subject, and chapter to begin your learning journey.</p>

          <div class="row">
            <div class="col-md-4">
              <label for="grade-select" class="form-label">Grade</label>
              <select class="form-select" id="grade-select">
                <option value="">Select Grade</option>
                <% @grades.each do |grade| %>
                  <option value="<%= grade.id %>"><%= grade.display_name %></option>
                <% end %>
              </select>
            </div>

            <div class="col-md-4">
              <label for="subject-select" class="form-label">Subject</label>
              <select class="form-select" id="subject-select" disabled>
                <option value="">Select Subject</option>
              </select>
            </div>

            <div class="col-md-4">
              <label for="chapter-select" class="form-label">Chapter</label>
              <select class="form-select" id="chapter-select" disabled>
                <option value="">Select Chapter</option>
              </select>
            </div>
          </div>

          <div class="text-center mt-4">
            <button id="startLearningBtn" class="btn btn-primary btn-lg" disabled onclick="startLearning()">
              Start Learning
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Quick Actions</h5>
          <div class="d-grid gap-2">
            <% if user_signed_in? %>
              <%= link_to "My Dashboard", profile_path, class: "btn btn-outline-primary" %>
              <%= link_to "View All Progress", profile_path, class: "btn btn-outline-success" %>
              <%= link_to "Ask a Doubt", questions_path, class: "btn btn-outline-secondary" %>
              <%= link_to "View History", history_path, class: "btn btn-outline-info" %>
              <% if current_user.admin? %>
                <%= link_to "Admin Dashboard", admin_dashboard_path, class: "btn btn-outline-warning" %>
              <% end %>
            <% else %>
              <%= link_to "Sign In", new_user_session_path, class: "btn btn-outline-primary" %>
              <%= link_to "Sign Up", new_user_registration_path, class: "btn btn-outline-secondary" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const gradeSelect = document.getElementById('grade-select');
  const subjectSelect = document.getElementById('subject-select');
  const chapterSelect = document.getElementById('chapter-select');
  const startLearningBtn = document.getElementById('startLearningBtn');

  gradeSelect.addEventListener('change', function() {
    const gradeId = this.value;
    if (gradeId) {
      // Show loading state
      subjectSelect.innerHTML = '<option value="">Loading...</option>';
      subjectSelect.disabled = true;

      fetch(`/grades/${gradeId}/subjects`, {
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(subjects => {
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        subjects.forEach(subject => {
          subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
        });
        subjectSelect.disabled = false;
        chapterSelect.disabled = true;
        chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
      })
      .catch(error => {
        console.error('Error loading subjects:', error);
        subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
        subjectSelect.disabled = true;
      });
    } else {
      subjectSelect.disabled = true;
      chapterSelect.disabled = true;
      subjectSelect.innerHTML = '<option value="">Select Subject</option>';
      chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
    }
  });

  subjectSelect.addEventListener('change', function() {
    const subjectId = this.value;
    const gradeId = gradeSelect.value;
    if (subjectId) {
      // Show loading state
      chapterSelect.innerHTML = '<option value="">Loading...</option>';
      chapterSelect.disabled = true;

      fetch(`/grades/${gradeId}/subjects/${subjectId}/chapters`, {
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(chapters => {
        chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
        chapters.forEach(chapter => {
          chapterSelect.innerHTML += `<option value="${chapter.id}">${chapter.name}</option>`;
        });
        chapterSelect.disabled = false;
      })
      .catch(error => {
        console.error('Error loading chapters:', error);
        chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
        chapterSelect.disabled = true;
      });
    } else {
      chapterSelect.disabled = true;
      chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
    }
  });

  chapterSelect.addEventListener('change', function() {
    const chapterId = this.value;
    startLearningBtn.disabled = !chapterId;
  });

  // Make startLearning function globally accessible
  window.startLearning = function() {
    const gradeId = document.getElementById('grade-select').value;
    const subjectId = document.getElementById('subject-select').value;
    const chapterId = document.getElementById('chapter-select').value;

    if (gradeId && subjectId && chapterId) {
      window.location.href = `/learning/${chapterId}`;
    } else {
      alert('Please select a grade, subject, and chapter first.');
    }
  };
});
</script>
