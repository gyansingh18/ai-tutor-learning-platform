<div class="container-fluid mt-4">
  <div class="row">
    <!-- Left Panel - Task Information -->
    <div class="col-md-4">
      <div class="card h-100 fade-in">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Task Information
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <h6 class="text-primary mb-2">
              <i class="fas fa-book me-2"></i>
              <%= @chapter.display_name %>
            </h6>
            <p class="text-muted mb-0">
              <i class="fas fa-tasks me-2"></i>
              Task <%= @task.order %> of <%= @chapter.total_tasks %>
            </p>
          </div>

          <div class="mb-4">
            <h6 class="text-success mb-2">
              <i class="fas fa-question-circle me-2"></i>
              Question
            </h6>
            <div class="task-content p-3 bg-light rounded">
              <%= @task.content %>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Progress</span>
              <span class="text-primary fw-bold"><%= @progress_percentage %>%</span>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar bg-primary" role="progressbar"
                   style="width: <%= @progress_percentage %>%"
                   aria-valuenow="<%= @progress_percentage %>"
                   aria-valuemin="0"
                   aria-valuemax="100"></div>
            </div>
          </div>

          <!-- Navigation Buttons -->
          <div class="d-grid gap-2">
            <% if @task.previous_task %>
              <%= link_to learning_task_path(@chapter, @task.previous_task), class: "btn btn-outline-primary" do %>
                <i class="fas fa-arrow-left me-2"></i>
                Previous Task
              <% end %>
            <% end %>

            <% if @task.next_task %>
              <%= link_to learning_task_path(@chapter, @task.next_task), class: "btn btn-outline-primary" do %>
                Next Task
                <i class="fas fa-arrow-right ms-2"></i>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Center Panel - Answer Input -->
    <div class="col-md-4">
      <div class="card h-100 fade-in">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-edit me-2"></i>
            Your Answer
          </h5>
        </div>
        <div class="card-body">
          <%= form_with url: submit_task_answer_path(@chapter, @task), method: :post, local: true, class: "h-100 d-flex flex-column" do |f| %>
            <div class="flex-grow-1">
              <% case @task.task_type %>
              <% when 'multiple_choice' %>
                <div class="mb-3">
                  <label class="form-label fw-bold">
                    <i class="fas fa-list-ul me-2"></i>
                    Select the correct answer:
                  </label>
                  <% LearningHelper.extract_options(@task.content).each_with_index do |option, index| %>
                    <div class="form-check mb-2">
                      <%= f.radio_button :answer, option, class: "form-check-input" %>
                      <%= f.label "answer_#{index}", option, class: "form-check-label" %>
                    </div>
                  <% end %>
                </div>
              <% when 'fill_in_blank' %>
                <div class="mb-3">
                  <label class="form-label fw-bold">
                    <i class="fas fa-pencil me-2"></i>
                    Fill in the blank:
                  </label>
                  <%= f.text_field :answer, class: "form-control", placeholder: "Enter your answer here..." %>
                </div>
              <% when 'true_false' %>
                <div class="mb-3">
                  <label class="form-label fw-bold">
                    <i class="fas fa-check-circle me-2"></i>
                    Select True or False:
                  </label>
                  <div class="form-check mb-2">
                    <%= f.radio_button :answer, "True", class: "form-check-input" %>
                    <%= f.label "answer_true", "True", class: "form-check-label" %>
                  </div>
                  <div class="form-check mb-2">
                    <%= f.radio_button :answer, "False", class: "form-check-input" %>
                    <%= f.label "answer_false", "False", class: "form-check-label" %>
                  </div>
                </div>
              <% when 'short_answer' %>
                <div class="mb-3">
                  <label class="form-label fw-bold">
                    <i class="fas fa-comment me-2"></i>
                    Write your answer:
                  </label>
                  <%= f.text_area :answer, class: "form-control", rows: 4, placeholder: "Enter your answer here..." %>
                </div>
              <% when 'coding' %>
                <div class="mb-3">
                  <label class="form-label fw-bold">
                    <i class="fas fa-code me-2"></i>
                    Write your code:
                  </label>
                  <%= f.text_area :answer, class: "form-control", rows: 8, placeholder: "Enter your code here...", style: "font-family: 'Roboto Mono', monospace;" %>
                </div>
              <% else %>
                <div class="mb-3">
                  <label class="form-label fw-bold">
                    <i class="fas fa-edit me-2"></i>
                    Your answer:
                  </label>
                  <%= f.text_area :answer, class: "form-control", rows: 4, placeholder: "Enter your answer here..." %>
                </div>
              <% end %>
            </div>

            <div class="mt-auto">
              <%= f.submit "Submit Answer", class: "btn btn-primary btn-lg w-100" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Right Panel - Results -->
    <div class="col-md-4">
      <div class="card h-100 fade-in">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>
            Results
          </h5>
        </div>
        <div class="card-body">
          <% if @last_answer %>
            <div class="text-center mb-4">
              <% if @last_answer.is_correct? %>
                <div class="text-success mb-3">
                  <i class="fas fa-check-circle fa-3x"></i>
                </div>
                <h5 class="text-success">Correct!</h5>
                <p class="text-muted">Great job! You got it right.</p>
              <% else %>
                <div class="text-danger mb-3">
                  <i class="fas fa-times-circle fa-3x"></i>
                </div>
                <h5 class="text-danger">Incorrect</h5>
                <p class="text-muted">Let's review the correct answer.</p>
              <% end %>
            </div>

            <div class="mb-4">
              <h6 class="text-primary mb-2">
                <i class="fas fa-comment me-2"></i>
                Your Answer
              </h6>
              <div class="p-3 bg-light rounded">
                <%= @last_answer.answer %>
              </div>
            </div>

            <% unless @last_answer.is_correct? %>
              <div class="mb-4">
                <h6 class="text-success mb-2">
                  <i class="fas fa-lightbulb me-2"></i>
                  Correct Answer
                </h6>
                <div class="p-3 bg-success bg-opacity-10 rounded">
                  <%= @correct_answer %>
                </div>
              </div>

              <div class="mb-4">
                <h6 class="text-info mb-2">
                  <i class="fas fa-info-circle me-2"></i>
                  Explanation
                </h6>
                <div class="p-3 bg-info bg-opacity-10 rounded">
                  <%= @explanation %>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-5">
              <i class="fas fa-arrow-left fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">Submit your answer</h5>
              <p class="text-muted">Your results will appear here after you submit your answer.</p>
            </div>
          <% end %>

          <!-- Next Steps -->
          <div class="mt-auto">
            <% if @task.next_task %>
              <%= link_to learning_task_path(@chapter, @task.next_task), class: "btn btn-primary w-100 mb-2" do %>
                Next Task
                <i class="fas fa-arrow-right ms-2"></i>
              <% end %>
            <% elsif @chapter.all_tasks_completed?(current_user) %>
              <%= link_to chapter_review_path(@chapter), class: "btn btn-success w-100" do %>
                <i class="fas fa-trophy me-2"></i>
                View Chapter Review
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.task-content {
  font-size: 1.1rem;
  line-height: 1.6;
}

.form-check-input:checked {
  background-color: var(--primary-blue);
  border-color: var(--primary-blue);
}

.form-check-label {
  cursor: pointer;
  padding-left: 0.5rem;
}

.form-check-label:hover {
  color: var(--primary-blue);
}

.card {
  box-shadow: var(--shadow-md);
  transition: var(--transition);
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn {
  transition: var(--transition);
}

.btn:hover {
  transform: translateY(-1px);
}

.progress {
  border-radius: 10px;
  overflow: hidden;
}

.progress-bar {
  transition: width 0.6s ease;
}

@media (max-width: 768px) {
  .container-fluid {
    padding: 1rem;
  }

  .row {
    margin: 0;
  }

  .col-md-4 {
    margin-bottom: 1rem;
  }
}
</style>
