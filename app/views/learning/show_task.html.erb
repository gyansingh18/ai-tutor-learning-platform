<!-- Completely Isolated Layout - Override All CSS -->
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; min-height: 100vh !important; display: flex !important; flex-direction: column !important; margin: 0 !important; padding: 0 !important; overflow: hidden !important;">

  <!-- Header -->
  <div style="background: #007bff !important; color: white !important; padding: 15px !important; flex-shrink: 0 !important; margin: 0 !important;">
    <div style="width: 100% !important;">
      <div style="display: flex !important; align-items: center !important; justify-content: space-between !important;">
        <div style="flex: 1 !important;">
          <h4 style="margin: 0 !important;">
            <i class="fas fa-graduation-cap me-2"></i>
            <%= @chapter.display_name %> - Task <%= @task.order %>
          </h4>
        </div>
        <div style="flex: 1 !important; text-align: right !important;">
          <div style="height: 25px !important; background: rgba(255,255,255,0.2) !important; border-radius: 4px !important; overflow: hidden !important; position: relative !important; display: flex !important; align-items: center !important; justify-content: center !important; min-width: 120px !important;">
            <div style="height: 100% !important; background: #28a745 !important; width: <%= [@progress, 5].max %>% !important; transition: width 0.3s !important; position: absolute !important; left: 0 !important; top: 0 !important;"></div>
            <span style="position: relative !important; z-index: 1 !important; color: white !important; font-weight: bold !important; font-size: 12px !important;"><%= @progress %>%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug -->
  <div style="background: #d1ecf1 !important; color: #0c5460 !important; padding: 12px !important; margin: 10px !important; border-radius: 4px !important; flex-shrink: 0 !important;">
    <strong>Debug:</strong> Task ID: <%= @task.id %>, Order: <%= @task.order %>, Chapter: <%= @chapter.id %>
  </div>

  <!-- Main Content Area - Three Panels -->
  <div style="flex: 1 !important; padding: 0 20px !important; margin-bottom: 20px !important; display: flex !important; gap: 20px !important; height: 100% !important;">

    <!-- Panel 1: Explanation -->
    <div style="flex: 1 !important; min-width: 0 !important;">
      <div style="background: white !important; border-radius: 8px !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important; height: 100% !important; display: flex !important; flex-direction: column !important;">
        <div style="background: #17a2b8 !important; color: white !important; padding: 12px !important; border-radius: 8px 8px 0 0 !important;">
          <h6 style="margin: 0 !important;"><i class="fas fa-book me-2"></i>Concept Explanation</h6>
        </div>
        <div style="flex: 1 !important; padding: 20px !important; overflow-y: auto !important;">
          <h6 style="color: #007bff !important;"><%= @task.title %></h6>
          <% explanation = LearningHelper.extract_explanation(@task.content) %>
          <% if explanation.present? %>
            <div style="padding: 15px !important; border-radius: 8px !important; background: #f8f9fa !important; margin-bottom: 15px !important;">
              <h6 style="color: #17a2b8 !important;">üìö Concept Explanation</h6>
              <div><%= simple_format(explanation) %></div>
            </div>
          <% end %>
          <% question = LearningHelper.extract_question(@task.content) %>
          <% if question.present? %>
            <div style="padding: 15px !important; border-radius: 8px !important; background: #f8f9fa !important; margin-bottom: 15px !important;">
              <h6 style="color: #ffc107 !important;">‚ùì Your Task</h6>
              <div><%= simple_format(question) %></div>
            </div>
          <% end %>
          <% hint = LearningHelper.extract_hint(@task.content) %>
          <% if hint.present? %>
            <div style="padding: 15px !important; border-radius: 8px !important; background: #f8f9fa !important; margin-bottom: 15px !important;">
              <h6 style="color: #28a745 !important;">üí° Hint</h6>
              <div><%= simple_format(hint) %></div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Panel 2: Input -->
    <div style="flex: 1 !important; min-width: 0 !important;">
      <div style="background: white !important; border-radius: 8px !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important; height: 100% !important; display: flex !important; flex-direction: column !important;">
        <div style="background: #ffc107 !important; color: #212529 !important; padding: 12px !important; border-radius: 8px 8px 0 0 !important;">
          <h6 style="margin: 0 !important;"><i class="fas fa-edit me-2"></i>Your Answer</h6>
        </div>
        <div style="flex: 1 !important; padding: 20px !important; overflow-y: auto !important;">
          <%= form_with url: submit_task_answer_path(@chapter, @task), method: :post, local: true do |f| %>
            <% if @task.multiple_choice? %>
              <div style="margin-bottom: 15px !important;">
                <label style="display: block !important; margin-bottom: 8px !important; font-weight: bold !important;">Select the correct answer:</label>
                <% LearningHelper.extract_options(@task.content).each_with_index do |option, index| %>
                  <div style="margin-bottom: 8px !important;">
                    <%= f.radio_button :answer, option, style: "margin-right: 8px !important;" %>
                    <%= f.label "answer_#{index}", option %>
                  </div>
                <% end %>
              </div>
            <% elsif @task.fill_in_blank? %>
              <div style="margin-bottom: 15px !important;">
                <label style="display: block !important; margin-bottom: 8px !important; font-weight: bold !important;">Fill in the blank:</label>
                <%= f.text_field :answer, style: "width: 100% !important; padding: 8px !important; border: 1px solid #ddd !important; border-radius: 4px !important;", placeholder: "Enter your answer..." %>
              </div>
            <% elsif @task.short_answer? %>
              <div style="margin-bottom: 15px !important;">
                <label style="display: block !important; margin-bottom: 8px !important; font-weight: bold !important;">Write your answer:</label>
                <%= f.text_area :answer, style: "width: 100% !important; padding: 8px !important; border: 1px solid #ddd !important; border-radius: 4px !important;", rows: 4, placeholder: "Write your detailed answer..." %>
              </div>
            <% elsif @task.true_false? %>
              <div style="margin-bottom: 15px !important;">
                <label style="display: block !important; margin-bottom: 8px !important; font-weight: bold !important;">Select true or false:</label>
                <div style="margin-bottom: 8px !important;">
                  <%= f.radio_button :answer, "true", style: "margin-right: 8px !important;" %>
                  <%= f.label "answer_true", "True" %>
                </div>
                <div style="margin-bottom: 8px !important;">
                  <%= f.radio_button :answer, "false", style: "margin-right: 8px !important;" %>
                  <%= f.label "answer_false", "False" %>
                </div>
              </div>
            <% elsif @task.coding? %>
              <div style="margin-bottom: 15px !important;">
                <label style="display: block !important; margin-bottom: 8px !important; font-weight: bold !important;">Write your code:</label>
                <%= f.text_area :answer, style: "width: 100% !important; padding: 8px !important; border: 1px solid #ddd !important; border-radius: 4px !important; font-family: monospace !important;", rows: 8, placeholder: "Write your code here..." %>
              </div>
            <% end %>
            <div style="margin-top: 20px !important;">
              <%= f.submit "Submit Answer", style: "width: 100% !important; padding: 10px !important; background: #007bff !important; color: white !important; border: none !important; border-radius: 4px !important; cursor: pointer !important;" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Panel 3: Results -->
    <div style="flex: 1 !important; min-width: 0 !important;">
      <div style="background: white !important; border-radius: 8px !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important; height: 100% !important; display: flex !important; flex-direction: column !important;">
        <div style="background: #28a745 !important; color: white !important; padding: 12px !important; border-radius: 8px 8px 0 0 !important;">
          <h6 style="margin: 0 !important;"><i class="fas fa-chart-line me-2"></i>Results & Feedback</h6>
        </div>
        <div style="flex: 1 !important; padding: 20px !important; overflow-y: auto !important;">
          <% if @student_answer&.answer.present? %>
            <div style="padding: 15px !important; border-radius: 8px !important; background: #f8f9fa !important;">
              <h6 style="color: #28a745 !important;">‚úÖ Answer Submitted</h6>
              <div style="margin-bottom: 15px !important;">
                <strong>Your Answer:</strong>
                <div style="padding: 8px !important; background: white !important; border-radius: 4px !important; border: 1px solid #ddd !important; margin-top: 5px !important;">
                  <%= @student_answer.answer %>
                </div>
              </div>
              <% if @student_answer.is_correct? %>
                <div style="padding: 12px !important; background: #d4edda !important; color: #155724 !important; border-radius: 4px !important; margin-bottom: 15px !important;">
                  <i class="fas fa-check-circle me-2"></i>
                  <strong>Correct!</strong> Great job!
                </div>
              <% else %>
                <div style="padding: 12px !important; background: #fff3cd !important; color: #856404 !important; border-radius: 4px !important; margin-bottom: 15px !important;">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Not quite right.</strong> Keep trying!
                </div>
                <div style="margin-top: 15px !important;">
                  <strong>Correct Answer:</strong>
                  <div style="padding: 8px !important; background: #28a745 !important; color: white !important; border-radius: 4px !important; margin-top: 5px !important;">
                    <%= LearningHelper.extract_correct_answer(@task.content) %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div style="text-align: center !important; color: #6c757d !important;">
              <i class="fas fa-arrow-left" style="font-size: 2em !important; margin-bottom: 15px !important; display: block !important;"></i>
              <p>Submit your answer to see results here</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer Navigation -->
  <div style="background: #f8f9fa !important; padding: 15px !important; flex-shrink: 0 !important;">
    <div style="display: flex !important; align-items: center !important; justify-content: space-between !important;">
      <div style="flex: 1 !important;">
        <% unless @task.is_first? %>
          <%= link_to "‚Üê Previous Task", previous_task_path(@chapter, @task), style: "padding: 8px 16px !important; background: transparent !important; color: #007bff !important; border: 1px solid #007bff !important; border-radius: 4px !important; text-decoration: none !important;" %>
        <% else %>
          <span style="color: #6c757d !important;">First Task</span>
        <% end %>
      </div>
      <div style="flex: 1 !important; text-align: center !important;">
        <span style="color: #6c757d !important;">Task <%= @task.order %> of <%= @chapter.tasks.count %></span>
      </div>
      <div style="flex: 1 !important; text-align: right !important;">
        <% unless @task.is_last? %>
          <%= link_to "Next Task ‚Üí", next_task_path(@chapter, @task), style: "padding: 8px 16px !important; background: #007bff !important; color: white !important; border: none !important; border-radius: 4px !important; text-decoration: none !important;" %>
        <% else %>
          <span style="color: #6c757d !important;">Last Task</span>
        <% end %>
      </div>
    </div>
  </div>

</div>
